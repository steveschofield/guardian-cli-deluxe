# Guardian CLI Deluxe - Kali Linux Docker Image
# Full automated build with all pentesting tools and Guardian dependencies
# Version: 2.0 - Production Ready

# Use official Kali Linux Rolling as base
FROM kalilinux/kali-rolling:latest

# Metadata
LABEL maintainer="steve@steveschofield.com"
LABEL description="Guardian CLI Deluxe - AI-Powered Penetration Testing Framework on Kali Linux"
LABEL version="2.0"

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Set working directory
WORKDIR /guardian

# ============================================================================
# STAGE 1: System Update and Base Packages
# ============================================================================

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    # Core utilities
    apt-utils \
    ca-certificates \
    curl \
    wget \
    git \
    vim \
    nano \
    unzip \
    zip \
    tar \
    gzip \
    bzip2 \
    xz-utils \
    # Build tools
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    # Network tools
    netcat-openbsd \
    net-tools \
    iputils-ping \
    dnsutils \
    traceroute \
    whois \
    # Process and system tools
    procps \
    htop \
    tmux \
    screen \
    sudo \
    # Python and pip
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    python3-setuptools \
    python3-wheel \
    # Additional dependencies
    libssl-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libjpeg-dev \
    libpq-dev && \
    # Clean up
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 2: Kali Linux Pentesting Tools
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    # Reconnaissance
    nmap \
    masscan \
    rustscan \
    netdiscover \
    arp-scan \
    dmitry \
    theharvester \
    sublist3r \
    amass \
    dnsenum \
    dnsrecon \
    fierce \
    # Web scanners
    nikto \
    whatweb \
    wpscan \
    dirb \
    dirbuster \
    gobuster \
    wfuzz \
    ffuf \
    # SMB/NetBIOS enumeration
    enum4linux \
    enum4linux-ng \
    smbclient \
    smbmap \
    nbtscan \
    rpcclient \
    samba-common-bin \
    # LDAP enumeration
    ldap-utils \
    # SNMP enumeration  
    snmp \
    snmpwalk \
    onesixtyone \
    # FTP/SSH/Telnet
    ftp \
    ssh \
    telnet \
    hydra \
    medusa \
    # SQL tools
    sqlmap \
    # Vulnerability scanners
    nuclei \
    # Exploitation frameworks
    metasploit-framework \
    # Network analysis
    wireshark \
    tshark \
    tcpdump \
    # SSL/TLS testing
    sslscan \
    sslyze \
    testssl.sh \
    # HTTP tools
    curl \
    wget \
    httpie \
    # Wordlists
    wordlists \
    # Other useful tools
    john \
    hashcat \
    aircrack-ng \
    crackmapexec \
    impacket-scripts \
    responder \
    && \
    # Clean up
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 3: Additional Security Tools (via pip and other sources)
# ============================================================================

# Upgrade pip first
RUN python3 -m pip install --upgrade pip setuptools wheel

# Install Python security tools
RUN pip install --no-cache-dir \
    # Core Guardian dependencies
    anthropic \
    langchain \
    langchain-community \
    langchain-anthropic \
    # AI/LLM dependencies
    openai \
    google-generativeai \
    # HTTP and API tools
    requests \
    httpx \
    aiohttp \
    # Data processing
    pyyaml \
    python-dotenv \
    click \
    rich \
    colorama \
    # Security tools
    impacket \
    crackmapexec \
    bloodhound \
    ldap3 \
    pysmb \
    pycryptodome \
    # Network tools
    scapy \
    python-nmap \
    # Web testing
    beautifulsoup4 \
    lxml \
    selenium \
    playwright \
    # Reporting
    jinja2 \
    markdown \
    reportlab \
    # Additional utilities
    paramiko \
    fabric \
    netmiko

# ============================================================================
# STAGE 4: Install Additional Tools from GitHub
# ============================================================================

# Create tools directory
RUN mkdir -p /opt/tools

# Install dalfox (XSS scanner)
RUN wget -q https://github.com/hahwul/dalfox/releases/download/v2.9.2/dalfox_2.9.2_linux_amd64.tar.gz && \
    tar -xzf dalfox_2.9.2_linux_amd64.tar.gz && \
    mv dalfox /usr/local/bin/ && \
    chmod +x /usr/local/bin/dalfox && \
    rm dalfox_2.9.2_linux_amd64.tar.gz

# Install commix (command injection)
RUN git clone --depth 1 https://github.com/commixproject/commix.git /opt/tools/commix && \
    ln -s /opt/tools/commix/commix.py /usr/local/bin/commix && \
    chmod +x /usr/local/bin/commix

# Install xsstrike
RUN git clone --depth 1 https://github.com/s0md3v/XSStrike.git /opt/tools/xsstrike && \
    pip install --no-cache-dir -r /opt/tools/xsstrike/requirements.txt

# Install sublist3r (if not already installed via apt)
RUN git clone --depth 1 https://github.com/aboul3la/Sublist3r.git /opt/tools/Sublist3r && \
    pip install --no-cache-dir -r /opt/tools/Sublist3r/requirements.txt

# ============================================================================
# STAGE 5: Setup Guardian CLI Deluxe
# ============================================================================

# Copy Guardian CLI Deluxe files
COPY . /guardian/

# Install Guardian Python dependencies
RUN if [ -f requirements.txt ]; then \
        pip install --no-cache-dir -r requirements.txt; \
    fi

# Install Guardian Python package (if setup.py exists)
RUN if [ -f setup.py ]; then \
        pip install --no-cache-dir -e .; \
    fi

# Make scripts executable
RUN find /guardian -name "*.sh" -type f -exec chmod +x {} \; && \
    find /guardian -name "*.py" -type f -exec chmod +x {} \;

# Create necessary directories
RUN mkdir -p /guardian/reports && \
    mkdir -p /guardian/logs && \
    mkdir -p /guardian/data && \
    mkdir -p /guardian/config && \
    mkdir -p /guardian/workflows && \
    mkdir -p /guardian/tools && \
    mkdir -p /root/.guardian

# ============================================================================
# STAGE 6: Configuration and Environment Setup
# ============================================================================

# Set up environment variables
ENV PATH="/guardian:/guardian/tools:/opt/tools:${PATH}"
ENV PYTHONPATH="/guardian:${PYTHONPATH}"
ENV GUARDIAN_HOME="/guardian"
ENV GUARDIAN_CONFIG="/guardian/config/guardian.yaml"

# Create guardian user (optional, for non-root operation)
RUN useradd -m -s /bin/bash guardian && \
    usermod -aG sudo guardian && \
    echo "guardian ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set permissions
RUN chown -R guardian:guardian /guardian && \
    chmod -R 755 /guardian

# ============================================================================
# STAGE 7: Verification and Testing
# ============================================================================

# Verify critical tools are installed
RUN echo "=== Verifying Tool Installation ===" && \
    which nmap && nmap --version && \
    which enum4linux && echo "enum4linux: OK" && \
    which enum4linux-ng && echo "enum4linux-ng: OK" && \
    which sqlmap && echo "sqlmap: OK" && \
    which nikto && echo "nikto: OK" && \
    which nuclei && nuclei -version && \
    which python3 && python3 --version && \
    which pip && pip --version && \
    echo "=== All Critical Tools Verified ==="

# Verify Python packages
RUN python3 -c "import anthropic; print('anthropic: OK')" && \
    python3 -c "import langchain; print('langchain: OK')" && \
    python3 -c "import yaml; print('pyyaml: OK')" && \
    python3 -c "import requests; print('requests: OK')" && \
    echo "=== All Python Packages Verified ==="

# ============================================================================
# STAGE 8: Entrypoint and Startup
# ============================================================================

# Create entrypoint script
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Display welcome banner' >> /entrypoint.sh && \
    echo 'cat << "EOF"' >> /entrypoint.sh && \
    echo '╔══════════════════════════════════════════════════════════╗' >> /entrypoint.sh && \
    echo '║     Guardian CLI Deluxe - Kali Linux Container          ║' >> /entrypoint.sh && \
    echo '║     AI-Powered Penetration Testing Framework            ║' >> /entrypoint.sh && \
    echo '╚══════════════════════════════════════════════════════════╝' >> /entrypoint.sh && \
    echo 'EOF' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'echo "Container started at $(date)"' >> /entrypoint.sh && \
    echo 'echo "Working directory: $(pwd)"' >> /entrypoint.sh && \
    echo 'echo ""' >> /entrypoint.sh && \
    echo 'echo "Quick Start:"' >> /entrypoint.sh && \
    echo 'echo "  python -m cli.main --help"' >> /entrypoint.sh && \
    echo 'echo "  python -m cli.main workflow list"' >> /entrypoint.sh && \
    echo 'echo ""' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Execute command or start bash' >> /entrypoint.sh && \
    echo 'if [ $# -eq 0 ]; then' >> /entrypoint.sh && \
    echo '    exec /bin/bash' >> /entrypoint.sh && \
    echo 'else' >> /entrypoint.sh && \
    echo '    exec "$@"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/entrypoint.sh"]

# Default command
CMD ["/bin/bash"]

# Expose common ports (optional, for services)
EXPOSE 8080 8443 4444 5555

# Health check (optional)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import sys; sys.exit(0)" || exit 1

# Final message
RUN echo "=== Guardian CLI Deluxe Kali Docker Image Built Successfully ==="
